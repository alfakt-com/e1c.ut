

Функция ПолучитьКодПодтверждения() Экспорт
	ГСЧ =  Новый ГенераторСлучайныхЧисел();
	СлучайноеЧисло = ГСЧ.СлучайноеЧисло(10000, 99999);
	Возврат СтрЗАменить(СлучайноеЧисло," ","")
КонецФункции 

Функция ОтправитьСМССообщениеПоНомеру(Телефон, Сообщение, Дост = Неопределено) Экспорт
	
	Объект  = Обработки.bon_ОбработкаСМС.Создать();
	СмсИД   = Объект.ОтправитьСМССообщениеПоНомеру(Телефон, Сообщение, Дост);
	
	//Если вернулась структура - значит включен старый поставщик.
	Если ТипЗнч(СмсИД)=Тип("Структура") Тогда
		Возврат СмсИд;
	КонецЕсли;
	//отправили. 
	Если СмсИД = "-1" ИЛИ Лев(СмсИД, 1)= "{" Тогда  //Обработка ошибки
		Результат = Ложь;
		Описание  = "Ошибка при отправке";
	ИначеЕсли ТипЗнч(СмсИД) = ТИП("Строка") Тогда  //Успех
		Результат = Истина;
		Описание  = "Количество отправленных сообщений  1";
	КонецЕсли;
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("Ид",СмсИД);
	СтруктураДанных.Вставить("Результат",Результат);
	СтруктураДанных.Вставить("Описание",Описание);	
	Возврат СтруктураДанных;
	
КонецФункции



///Сергей 10.11.2020 +++ Формируем список для отправки смс по самовывозу
Процедура СформироватьСписокПоСамоВывозу() Экспорт 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Infor_СтатусыВМС.Объект КАК СсылкаЗаказ,
	|	Infor_СтатусыВМС.Объект.Контрагент КАК Контрагент,
	|	Infor_СтатусыВМС.Объект.Контрагент.Партнер КАК Партнер
	|ПОМЕСТИТЬ ТабОбъект
	|ИЗ
	|	РегистрСведений.Infor_СтатусыВМС КАК Infor_СтатусыВМС
	|ГДЕ
	|	Infor_СтатусыВМС.Склад = &Склад
	|	И Infor_СтатусыВМС.СтатусЗаказа = &СтатусЗаказа
	|	И Infor_СтатусыВМС.Объект ССЫЛКА Документ.ЗаказКлиента
	|	И Infor_СтатусыВМС.Объект.Дата >= &ДатаНач
	|	И Infor_СтатусыВМС.Объект.Статус <> &СтатусЗакрыт
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабОбъект.СсылкаЗаказ КАК СсылкаЗаказ,
	|	ТабОбъект.Контрагент КАК Контрагент,
	|	ТабОбъект.Партнер КАК Партнер,
	|	ПартнерыКонтактнаяИнформация.НомерТелефонаБезКодов КАК НомерТелефона,
	|	ЕСТЬNULL(ПартнерыДополнительныеРеквизитыСМС.Значение, ЛОЖЬ) КАК ОтправлятьСМС
	|ПОМЕСТИТЬ ТабРезСНом
	|ИЗ
	|	ТабОбъект КАК ТабОбъект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры.КонтактнаяИнформация КАК ПартнерыКонтактнаяИнформация
	|		ПО ТабОбъект.Партнер = ПартнерыКонтактнаяИнформация.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры.ДополнительныеРеквизиты КАК ПартнерыДополнительныеРеквизитыСМС
	|		ПО ТабОбъект.Партнер = ПартнерыДополнительныеРеквизитыСМС.Ссылка
	|			И (ПартнерыДополнительныеРеквизитыСМС.Свойство = &СМСУведомление)
	|ГДЕ
	|	ПартнерыКонтактнаяИнформация.Тип = &Тип
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТабРезСНом.СсылкаЗаказ КАК СсылкаЗаказ,
	|	ТабРезСНом.Контрагент КАК Контрагент,
	|	ТабРезСНом.Партнер КАК Партнер,
	|	ТабРезСНом.НомерТелефона КАК НомерТелефона
	|ИЗ
	|	ТабРезСНом КАК ТабРезСНом
	|ГДЕ
	|	(ТабРезСНом.Партнер.ЮрФизЛицо = &ЮрФизЛицо
	|			ИЛИ ТабРезСНом.ОтправлятьСМС = ИСТИНА)
	|	И ТабРезСНом.СсылкаЗаказ.СпособДоставки = &СпособДоставки
	|
	|СГРУППИРОВАТЬ ПО
	|	ТабРезСНом.СсылкаЗаказ,
	|	ТабРезСНом.Контрагент,
	|	ТабРезСНом.Партнер,
	|	ТабРезСНом.НомерТелефона";
	Запрос.УстановитьПараметр("Склад", 			Справочники.Склады.НайтиПоНаименованию("Альфа Логистик WMS"));
	Запрос.УстановитьПараметр("СтатусЗаказа", 	Перечисления.Infor_СтатусыВМС.УпаковкаЗавершена);
	Запрос.УстановитьПараметр("ДатаНач", 		НачалоДня('20201111'));
	Запрос.УстановитьПараметр("Тип", 			Перечисления.ТипыКонтактнойИнформации.Телефон);
	Запрос.УстановитьПараметр("ЮрФизЛицо", 		Перечисления.КомпанияЧастноеЛицо.ЧастноеЛицо);
	Запрос.УстановитьПараметр("СпособДоставки", Перечисления.СпособыДоставки.Самовывоз);
	Запрос.УстановитьПараметр("СтатусЗакрыт", 	Перечисления.СтатусыЗаказовКлиентов.Закрыт);
	Запрос.УстановитьПараметр("СМСУведомление", ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя","SMSУведомление"));
	
	РезЗап = Запрос.Выполнить().Выгрузить();
	
	ТзДанСамовывоз = Новый ТаблицаЗначений;	
	ТзДанСамовывоз.Колонки.Добавить("СсылкаЗаказ",,"СсылкаЗаказ");
	ТзДанСамовывоз.Колонки.Добавить("Контрагент",,"Контрагент");
	ТзДанСамовывоз.Колонки.Добавить("Партнер",,"Партнер");
	ТзДанСамовывоз.Колонки.Добавить("НомерТелефона",,"НомерТелефона");
	
	Если РезЗап.Количество() > 0 Тогда
		Для Каждого ТабЗнач Из РезЗап Цикл 
			///------------------------------------------///
			///Проверка на заполнение номера
			Если СтрДлина(ТабЗнач.НомерТелефона) <> 10 Тогда
				Продолжить;
			КонецЕсли;
			
			///Проверка чтобы были только "Цифры"
			Цифры = "0123456789";
			СтрКоличество = СтрДлина(ТабЗнач.НомерТелефона);
			Для Счетчик = 1 По СтрКоличество Цикл
				Если Найти(Цифры,Сред(ТабЗнач.НомерТелефона, Счетчик, 1)) = 0 Тогда
					Продолжить;
				КонецЕсли;
			КонецЦикла;
			
			///Проверка на первую цыфору чтобы бала "7"
			Если Число(Сред(ТабЗнач.НомерТелефона, 1 ,1)) <> 7 Тогда
				Продолжить;	
			КонецЕсли;			
			///-----------------------------------------///
			
			ЕстьСовпад = Число(0);
			Если ТзДанСамовывоз.Количество() = 0 Тогда			
				НовСтр = ТзДанСамовывоз.Добавить();
				НовСтр.СсылкаЗаказ 		= ТабЗнач.СсылкаЗаказ;
				НовСтр.Контрагент 		= ТабЗнач.Контрагент;
				НовСтр.Партнер 			= ТабЗнач.Партнер;
				НовСтр.НомерТелефона 	= ТабЗнач.НомерТелефона;
				ЕстьСовпад = ЕстьСовпад + Число(1);
			Иначе 
				Для Каждого СтрНабДан Из ТзДанСамовывоз Цикл
					Если ТабЗнач.СсылкаЗаказ = СтрНабДан.СсылкаЗаказ Тогда
						ЕстьСовпад = ЕстьСовпад + Число(0);	
					КонецЕсли;
				КонецЦикла;				
			КонецЕсли;
			
			Если ЕстьСовпад = Число(0) Тогда
				НовСтр = ТзДанСамовывоз.Добавить();
				НовСтр.СсылкаЗаказ 		= ТабЗнач.СсылкаЗаказ;
				НовСтр.Контрагент 		= ТабЗнач.Контрагент;
				НовСтр.Партнер 			= ТабЗнач.Партнер;
				НовСтр.НомерТелефона 	= ТабЗнач.НомерТелефона;
			КонецЕсли;
		КонецЦикла;                                       		
	КонецЕсли;	
	
	Если ТзДанСамовывоз.Количество() > 0 Тогда
		Для Каждого СтрОбх Из ТзДанСамовывоз Цикл 	
			ДаныеВРег = Новый Запрос;
			ДаныеВРег.Текст = "ВЫБРАТЬ
			|	new_ОтправкаСМСКлиентам.Документ КАК Документ,
			|	new_ОтправкаСМСКлиентам.Контрагент КАК Контрагент,
			|	new_ОтправкаСМСКлиентам.Телефон КАК Телефон
			|ИЗ
			|	РегистрСведений.new_ОтправкаСМСКлиентам КАК new_ОтправкаСМСКлиентам
			|ГДЕ
			|	new_ОтправкаСМСКлиентам.Документ = &Документ";
			ДаныеВРег.УстановитьПараметр("Документ", СтрОбх.СсылкаЗаказ);
			
			РезДаныеВРег = ДаныеВРег.Выполнить().Выгрузить();
			
			Если РезДаныеВРег.Количество() = Число(0) Тогда
				///---Добавляем запись---\\\
				МенеджерЗаписи = РегистрыСведений.new_ОтправкаСМСКлиентам.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.Телефон 				= СтрОбх.НомерТелефона;  
				МенеджерЗаписи.Контрагент 			= СтрОбх.Контрагент;
				МенеджерЗаписи.Документ 			= СтрОбх.СсылкаЗаказ;
				МенеджерЗаписи.ДатаЗаписи 			= ТекущаяДата();
				МенеджерЗаписи.ТекстОтправки 		= Константы.bon_ТекстОтправкиСМСОСамовывозе.Получить();
				МенеджерЗаписи.Записать();
				///---Добавляем запись---\\\
			КонецЕсли;
		КонецЦикла;		
	КонецЕсли;
	
КонецПроцедуры
///Сергей 10.11.2020 --- Формируем список для отправки смс по самовывозу

///Сергей 10.11.2020 +++ ///---Отправляем смс по самовывозу---\\\
Процедура ОтправитьСМСсРегистраnew_ОтправкаСМСКлиентам() Экспорт 
	
	НаборЗаписей = РегистрыСведений.new_ОтправкаСМСКлиентам.СоздатьНаборЗаписей();
	Отбор = НаборЗаписей.Отбор;
	Отбор.Отправлено.Установить(Ложь);
	НаборЗаписей.Прочитать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	new_ОтправкаСМСКлиентам.Телефон КАК Телефон,
	               |	new_ОтправкаСМСКлиентам.Контрагент КАК Контрагент,
	               |	new_ОтправкаСМСКлиентам.Документ КАК Документ,
	               |	new_ОтправкаСМСКлиентам.ДатаЗаписи КАК ДатаЗаписи,
	               |	new_ОтправкаСМСКлиентам.ДатаОтправки КАК ДатаОтправки,
	               |	new_ОтправкаСМСКлиентам.Отправлено КАК Отправлено,
	               |	new_ОтправкаСМСКлиентам.ТекстОтправки КАК ТекстОтправки
	               |ИЗ
	               |	РегистрСведений.new_ОтправкаСМСКлиентам КАК new_ОтправкаСМСКлиентам
	               |ГДЕ
	               |	new_ОтправкаСМСКлиентам.Отправлено = ЛОЖЬ";
	РезДан = Запрос.Выполнить().Выгрузить();
	
	
	
	Если РезДан.Количество() > 0 Тогда
		Для каждого Запись Из РезДан Цикл
			НаборЗаписей = РегистрыСведений.new_ОтправкаСМСКлиентам.СоздатьНаборЗаписей();
			Отбор = НаборЗаписей.Отбор;
			Отбор.Документ.Установить(Запись.Документ);
			Отбор.ДатаЗаписи.Установить(Запись.ДатаЗаписи);
			Отбор.Телефон.Установить(Запись.Телефон);
			НаборЗаписей.Прочитать();	
			
			Для Каждого ЗаписьПолуч Из НаборЗаписей Цикл  
				ЗаписьПолуч.ДатаОтправки = ТекущаяДата();		
				
				ТекстСообщения = ЗаписьПолуч.ТекстОтправки;
				Дост=Число(88);
				ТелефонСотовыйСМС	= "7"+Прав(ЗаписьПолуч.Телефон, 10);
				Структура = ОтправитьСМССообщениеПоНомеру(ТелефонСотовыйСМС, ТекстСообщения, Дост);
				Ответ = Структура.Описание + " " + Структура.Ид;
				Если Структура.Результат = Истина Тогда
					ЗаписьПолуч.Отправлено = Истина;
				КонецЕсли;
			КонецЦикла;
			НаборЗаписей.Записать();
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры
///Сергей 10.11.2020 --- ///---Отправляем смс по самовывозу---\\\



