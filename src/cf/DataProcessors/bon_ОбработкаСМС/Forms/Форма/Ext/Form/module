
Процедура ПриОткрытии()
	
	ЗаполнитьПостроительОтбора();
	ПрочитатьСписокОтправителей();
	Если SMSUser = "" ИЛИ SMSPass = "" Тогда
		ЭлементыФормы.ГлавнаяПанель.ТекущаяСтраница = ЭлементыФормы.ГлавнаяПанель.Страницы[3];
	Иначе  
		ФормаОбновитьБаланс();
	КонецЕсли;  
	ФормаОбработатьТекстСМС();
	ОбновитьИнфоОтправки();
	ЭлементыФормы.SMSTimeTest.Доступность = ОтложитьОтправкуТест;
	ЭлементыФормы.SMSTime.Доступность = ОтложитьОтправку;
	Попытка
		КонтактнаяИнформация.Отбор.Тип.Установить(Перечисления.ТипыКонтактнойИнформации.Телефон);
	Исключение
	КонецПопытки;
    //Максимальное количество получателей в одном пакете массовой рассылки
	МаксКолНомеровЗаРаз = 200;
КонецПроцедуры

Процедура ПриЗакрытии()
	ЗаписатьСписокОтправителей();
	СохранитьЗначение("ОтборКИ", ПостроительОтбора.ПолучитьНастройки(Истина, Ложь, Ложь, Ложь, Ложь));
КонецПроцедуры

Функция ФормаОбновитьБаланс()
	Баланс = ПолучитьБаланс();
	ЭлементыФормы.НадписьБаланс.Значение = "Баланс: " + Баланс;
	Возврат  Баланс;
КонецФункции

///////////////////////////////////////////////////////
//Процедуры работы со списком отправителей
///////////////////////////////////////////////////////

Процедура ЗаписатьСписокОтправителей()
	ВыбФайл = Новый Файл(ИмяФайлаОтправителей);
	Если НЕ ВыбФайл.Существует() Тогда
		Если НЕ ВыбратьФайлОтправителей() ТОгда
			Сообщить("Список отправителей не записан!", СтатусСообщения.Внимание);
			Возврат;
		КонецЕсли;	
	КонецЕсли;
	Док = Новый ТекстовыйДокумент;
	Для каждого Строка Из СписокОтправителей Цикл
		Док.ДобавитьСтроку(Строка.Наименование);
	КонецЦикла;
	Док.Записать(ИмяФайлаОтправителей); 
КонецПроцедуры

Процедура ПрочитатьСписокОтправителей()
	ВыбФайл = Новый Файл(ИмяФайлаОтправителей);
	Если ВыбФайл.Существует() Тогда
		Док = Новый ТекстовыйДокумент;
		Док.Прочитать(ИмяФайлаОтправителей);
		КолСтрок =  Док.КоличествоСтрок();
		Для Ном = 1 По КолСтрок Цикл
			Строка = СписокОтправителей.Добавить();
			Строка.Наименование = Док.ПолучитьСтроку(Ном);
		КонецЦикла;
	Иначе
		//Создаем Файл 
		ИмяФайлаОтправителей= "СписокОтправителей.txt";
		ВыбФайл = Новый ТекстовыйДокумент;
		ВыбФайл.Записать(ИмяФайлаОтправителей);
		Строка = СписокОтправителей.Добавить();
		Строка.Наименование = SMSFrom;
		ЗаписатьСписокОтправителей();
	КонецЕсли;
	ОбновитьСписокВыбораОтправителя();
КонецПроцедуры

Процедура ОбновитьСписокВыбораОтправителя();
	ЭлементыФормы.SMSFrom.СписокВыбора.ЗагрузитьЗначения(СписокОтправителей.ВыгрузитьКолонку("Наименование"));
	ЭлементыФормы.SMSFrom.Значение = SMSFrom;
КонецПроцедуры

Функция ВыбратьФайлОтправителей()
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ВыбФайл = Новый Файл(ИмяФайлаОтправителей);
	Если ВыбФайл.Существует() Тогда
		Диалог.ПолноеИмяФайла = ВыбФайл.Имя;
		Диалог.Каталог = ВыбФайл.Путь;
	Иначе
		Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
		Диалог.ПолноеИмяФайла= "СписокОтправителей.txt";
	КонецЕсли;
	
	Диалог.Заголовок = "Укажите файл со списком отправителей";
	Диалог.Фильтр = "Текстовые файлы (*.txt)|*.txt|Все файлы (*.*)|*.*";
	Диалог.Расширение = "txt";
	Если Диалог.Выбрать() Тогда
		ИмяФайлаОтправителей = Диалог.ПолноеИмяФайла;
		ПрочитатьСписокОтправителей();
		Возврат Истина;
	Иначе
		Сообщить("Файл не создан!");
		Возврат Ложь;
	КонецЕсли;			
	
КонецФункции



///////////////////////////////////////////////////////
//Обработка событий элементов управления формы
///////////////////////////////////////////////////////

Процедура КнопкаОтправкаНажатие(Элемент)
	SMSID = Отправка(ОтложитьОтправкуТест);
	ФормаОбновитьБаланс();
КонецПроцедуры

Процедура КнопкаМассоваяОтправкаНажатие(Элемент)
	SMSID = МассоваяОтправка(ОтложитьОтправку);
	ФормаОбновитьБаланс();
КонецПроцедуры

Процедура КнопкаКабинетНажатие(Элемент)
	ПереходВЛичныйКабинет()
КонецПроцедуры

Процедура КнопкаРегистрацияНажатие(Элемент)
	ПереходВРегистрацию()
КонецПроцедуры

Процедура КнопкаЗабылиПарольНажатие(Элемент)
	ПереходВЗабылиПароль()
КонецПроцедуры

Процедура КнопкаЗаполнитьНажатие(Элемент)
	ЗаполнитьИзРегистраКИ();
	ПреобразоватьНомераТелефонов();
КонецПроцедуры

Процедура КнопкаСохранитьБазуНажатие(Элемент)
	СохранитьБазу();
КонецПроцедуры

Процедура КнопкаЗагрузитьБазу(Элемент)
	ВвестиПараметрыЗагрузки();
	ЗагрузитьБазу();	
	ПреобразоватьНомераТелефонов();
КонецПроцедуры

Процедура УстановитьФлажки(Кнопка)
	Для каждого Строка Из ТаблицаКонтактов Цикл
		Строка.Флаг = Истина;
	КонецЦикла; 
КонецПроцедуры

Процедура СнятьФлажки(Кнопка)
	Для каждого Строка Из ТаблицаКонтактов Цикл
		Строка.Флаг = Ложь;
	КонецЦикла; 
КонецПроцедуры

Процедура КоманднаяПанель4Очистить(Кнопка)
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Вы уверены, что хотите очистить таблицу контактов?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ТаблицаКонтактов.Очистить();
		ОбновитьИнфоОтправки()
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель4ОбработатьНомера(Кнопка)
	ПреобразоватьНомераТелефонов();
КонецПроцедуры

Процедура КнопкаБалансНажатие(Элемент)
	ФормаОбновитьБаланс()
КонецПроцедуры

Процедура КнопкаОбновитьИнфоТекстаНажатие(Элемент)
	ФормаОбработатьТекстСМС()
КонецПроцедуры

Процедура КнопкаУточнитьСтатусНажатие(Элемент)
	Статус=SMS_Статус(SMSServer,SMSUser,SMSPass,SMSID);
КонецПроцедуры

Процедура СписокОтправителейНаименованиеПриИзменении(Элемент)
	Sender = ЭлементыФормы.СписокОтправителей.ТекущиеДанные.Наименование;
	Если НЕ ПроверитьНаименованиеОтправителя(Sender) Тогда ЭлементыФормы.СписокОтправителей.ТекущиеДанные.Наименование = ""; КонецЕсли;
КонецПроцедуры

Процедура SMS_UserTextПриИзменении(Элемент)
	ФормаОбработатьТекстСМС()
КонецПроцедуры

Процедура ИмяФайлаОтправителейНачалоВыбора(Элемент, СтандартнаяОбработка)
	ВыбратьФайлОтправителей()
КонецПроцедуры

Процедура ТаблицаКонтактовПриИзмененииФлажка(Элемент, Колонка)
	ОбновитьИнфоОтправки();
КонецПроцедуры

Процедура SMS_ToПриИзменении(Элемент)
	ПроверитьНомерТелефона(SMSTo); 
КонецПроцедуры

Процедура СписокОтправителейПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	ОбновитьСписокВыбораОтправителя();
КонецПроцедуры

Процедура ПереключательОтложитьТестПриИзменении(Элемент)
	ЭлементыФормы.SMSTimeTest.Доступность = ОтложитьОтправкуТест;
КонецПроцедуры

Процедура ПереключательОтложитьПриИзменении(Элемент)
	ЭлементыФормы.SMSTime.Доступность = ОтложитьОтправку;
КонецПроцедуры

Процедура SMSTimeTestОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Если Лев(ВыбранноеЗначение,10) = Лев(ТекущаяДата(),10) Тогда  
		Элемент.Значение = ТекущаяДата()+ 60; 
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
КонецПроцедуры

Процедура  ФормаОбработатьТекстСМС()
	ДлинаСМССимв =0;
	КоличествоСообщений =0;
	ОбработатьТекстСМС(ДлинаСМССимв,КоличествоСообщений);
	ЭлементыФормы.НадписьОписаниеТекста.Значение =  "Длина сообщения: " + ДлинаСМССимв + " симв., кол-во. сообщений: " + КоличествоСообщений;
КонецПроцедуры

Процедура ОбновитьИнфоОтправки()
	ВыбСтроки = ТаблицаКонтактов.НайтиСтроки(Новый Структура("Флаг",Истина)); 
	КолСтрок = ВыбСтроки.Количество();
	ЭлементыФормы.НадписьИнфоОтправка.Значение = "Всего к отправке: " + КолСтрок + " абонентов ";
	Если КолСтрок = 0  Тогда  //если  нет абонентов
		Текст = "Для осуществления массовой рассылки заполните список получателей на закладке 'База абонентов'";
	Иначе
		
		Текст = "Список получателей заполнен и содержит номеров: " + КолСтрок + ". Для осуществления массовой рассылки нажмите 'Отправить'";
	КонецЕсли;
	ЭлементыФормы.НадписьИнфоМассоваяРассылка.Значение = Текст;	
КонецПроцедуры

Процедура ПреобразоватьНомераТелефонов()
	
	Для Каждого Строка Из ТаблицаКонтактов Цикл   //Убираем из номера телефона лишние знаки
		Попытка
			Строка.НомерАбонента = ПреобразоватьНомерТелефона(Строка.Представление);
			Если Строка.НомерАбонента = "" Тогда Строка.Флаг = Ложь; КонецЕсли;
			ОбновитьИнфоОтправки()
		Исключение
			Сообщить("Не обработан номер " + Строка.Представление + " в строке " + Строка.Индекс);
			Сообщить(ОписаниеОшибки());	       
		КонецПопытки;	
	КонецЦикла;	
	
КонецПроцедуры


