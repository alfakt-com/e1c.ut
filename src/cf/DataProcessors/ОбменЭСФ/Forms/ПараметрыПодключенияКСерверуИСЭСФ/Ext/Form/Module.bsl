// Форма используется для
// - Настройки параметров подключения к ИС ЭСФ
// - Настройки параметров прокси-сервера при выходе в интернет (при обращении к ИС ЭСФ и при обращении к ресурсу для скачивания компоненты криптографии)

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ПараметрыПодключения = ЭСФСервер.ПолучитьПараметрыПодключенияКСерверуИСЭСФ();
	
	//Параметры прокси-сервера настраиваются в отдельном окне. Но здесь запомним их, чтобы при схранении записать 
	//ранее установленные параметры
	ПроксиСервер_ВариантИспользования 	 = ПараметрыПодключения.ПроксиСервер_ВариантИспользования;
	ПроксиСервер_Пароль					 = ПараметрыПодключения.ПроксиСервер_Пароль;
	ПроксиСервер_Пользователь			 = ПараметрыПодключения.ПроксиСервер_Пользователь;
	ПроксиСервер_Порт					 = ПараметрыПодключения.ПроксиСервер_Порт;
	ПроксиСервер_Сервер					 = ПараметрыПодключения.ПроксиСервер_Сервер;

	СерверИСЭСФ_HTTPS 					 = ПараметрыПодключения.СерверИСЭСФ_HTTPS;
	СерверИСЭСФ_Адрес					 = ПараметрыПодключения.СерверИСЭСФ_Адрес;	
	СерверИСЭСФ_ПолныйАдрес				 = ПараметрыПодключения.СерверИСЭСФ_ПолныйАдрес;
	СерверИСЭСФ_Порт					 = ПараметрыПодключения.СерверИСЭСФ_Порт;
	СерверИСЭСФ_Ресурс					 = ПараметрыПодключения.СерверИСЭСФ_Ресурс;
	СерверИСЭСФ_Таймаут					 = ПараметрыПодключения.СерверИСЭСФ_Таймаут;
	
	//
	ПараметрыЭСФ = ЭСФСервер.ПолучитьПараметрыЭСФ();
	ВерсияИСЭСФ = ПараметрыЭСФ.ВерсияИСЭСФ;
	
	//ПризнакОткрытияФормыДляНастройкиПрокси = Параметры.ЦельОткрытияФормы = "НастройкаПрокси";
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Контейнер = ЭСФКлиентСервер.КонтейнерМетодов();	
	Контейнер.ПриОткрытииФормы(ЭтаФорма, Отказ);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;	
	
	УправлениеФормой();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура ОК(Команда)
	
	СохранитьНастройкиПодключения();
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура Отмена(Команда)
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура Заполнить(Команда)
	
	ЗаполнитьНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	
	СерверИСЭСФ_HTTPS = "";
	СерверИСЭСФ_Адрес = "";
	СерверИСЭСФ_Порт = "";
	СерверИСЭСФ_Ресурс = "";
	СерверИСЭСФ_Таймаут = 0;
	
	Попытка
		
		ПараметрыПодключения = ЭСФСервер.ПараметрыПодключенияКСерверуИСЭСФ(СерверИСЭСФ_ПолныйАдрес);
		
		СерверИСЭСФ_HTTPS = ПараметрыПодключения.HTTPS;
		СерверИСЭСФ_Адрес = ПараметрыПодключения.Адрес;
		СерверИСЭСФ_Порт = ПараметрыПодключения.Порт;
		СерверИСЭСФ_Ресурс = ПараметрыПодключения.Ресурс;
		
		
	Исключение
		
		Сообщить(НСтр("ru = 'Не удалось разобрать адрес сервера на составные части.'"));
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура Восстановить(Команда)
	
	ВосстановитьИЗаполнить();
	
КонецПроцедуры

&НаСервере
Процедура ВосстановитьИЗаполнить()
	
	ОбработкаОбменЭСФ = ЭСФСерверПовтИсп.ОбработкаОбменЭСФ();
	СерверИСЭСФ_ПолныйАдрес = ОбработкаОбменЭСФ.АдресСервераAPIИСЭСФ();	
	
	ЗаполнитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьВерсиюИСЭСФ(Команда)
	
	ОбновитьВерсиюИСЭСФНаСервере();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаКлиенте
Процедура УправлениеФормой()
		
КонецПроцедуры

&НаСервере
Процедура СохранитьНастройкиПодключения()
	
	ПараметрыПодключения = ЭСФСервер.ПустыеПараметрыПодключенияКСерверуИСЭСФ();
	
	ПараметрыПодключения.ПроксиСервер_ВариантИспользования	 = ПроксиСервер_ВариантИспользования;
	ПараметрыПодключения.ПроксиСервер_Пароль				 = ПроксиСервер_Пароль;
	ПараметрыПодключения.ПроксиСервер_Пользователь			 = ПроксиСервер_Пользователь;
	ПараметрыПодключения.ПроксиСервер_Порт					 = ПроксиСервер_Порт;
	ПараметрыПодключения.ПроксиСервер_Сервер				 = ПроксиСервер_Сервер;

	ПараметрыПодключения.СерверИСЭСФ_HTTPS					 = СерверИСЭСФ_HTTPS;
	ПараметрыПодключения.СерверИСЭСФ_Адрес					 = СерверИСЭСФ_Адрес;
	ПараметрыПодключения.СерверИСЭСФ_ПолныйАдрес			 = СерверИСЭСФ_ПолныйАдрес;
	ПараметрыПодключения.СерверИСЭСФ_Порт					 = СерверИСЭСФ_Порт;
	ПараметрыПодключения.СерверИСЭСФ_Ресурс					 = СерверИСЭСФ_Ресурс;
	ПараметрыПодключения.СерверИСЭСФ_Таймаут				 = СерверИСЭСФ_Таймаут;
	
	ЭСФСервер.СохранитьПараметрыПодключенияКСерверуИСЭСФ(ПараметрыПодключения);
	
	//
	ПараметрыЭСФ = ЭСФСервер.ПолучитьПараметрыЭСФ();
	ПараметрыЭСФ.ВерсияИСЭСФ = ВерсияИСЭСФ ;
	
	ЭСФСервер.СохранитьПараметрыЭСФ(ПараметрыЭСФ);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьВерсиюИСЭСФНаСервере() Экспорт
	
	ТекстОшибки = "";
	НоваяВерсияИСЭСФ = ЭСФСервер.ВерсияИСЭСФ(ТекстОшибки);

	Если НоваяВерсияИСЭСФ = Неопределено Тогда
		Сообщить(НСтр("ru = 'Не удалось обновить версию ИС ЭСФ:'") + ТекстОшибки + " 
		| Установлена версия по умолчанию.");
		
		НоваяВерсияИСЭСФ = "5.0.0";
	КонецЕсли;
	
	ВерсияИСЭСФ = НоваяВерсияИСЭСФ;
	
КонецПроцедуры

