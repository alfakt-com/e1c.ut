
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	КоличествоНастроек = Б24_СинхронизацияВызовСервера.ПолучитьКоличествоНастроекСинхронизации(Истина);
	
	Если КоличествоНастроек > 1 тогда
		 
		ВыбЗнач 	= Неопределено;
		
		Массив 		= Новый Массив;
		Массив.Добавить(Тип("СправочникСсылка.Б24_НастройкиСинхронизацииСБитрикс24"));
		ОписаниеТипов = Новый ОписаниеТипов(Массив);
		
		Оповещение = Новый ОписаниеОповещения("ПослеВводаЗначения", ЭтотОбъект);

		ПоказатьВводЗначения(Оповещение, ВыбЗнач, "Укажите настройку синхронизации", ОписаниеТипов);	
		
	Иначе
		Параметры = Новый Структура;	
		ПослеВводаЗначения(Б24_СинхронизацияВызовСервера.ПолучитьНастройкуСинхронизацииПоУмолчанию(Истина), Параметры);	
	КонецЕсли;
	
КонецПроцедуры

&НаСервере	
Процедура ЗапуститьФоновоеЗаданиеЗагрузкиРеальногоВремени(НаименованиеФоновогоЗадания, НастройкаСинхронизации)
	
	УникальныйИдентификатор 	= новый УникальныйИдентификатор;
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияВФоне(УникальныйИдентификатор);
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = НаименованиеФоновогоЗадания;
	ПараметрыВыполнения.ОжидатьЗавершение = 0;
	
	ПараметрыВыгрузки = Новый Структура;
	ПараметрыВыгрузки.Вставить("НастройкаСинхронизации", НастройкаСинхронизации);
	
	ДлительныеОперации.ВыполнитьВФоне("Б24_СинхронизацияКлиентСервер.ЗапуститьЗагрузкуВРежимеРеальногоВремениВФоне", ПараметрыВыгрузки, ПараметрыВыполнения);
	
КонецПроцедуры


&НаКлиенте
Процедура ПослеВводаЗначения(НастройкаСинхронизации, Параметры) Экспорт
	
	Если ЗначениеЗаполнено(НастройкаСинхронизации) Тогда

		Если Б24_ОбщегоНазначенияСервер.ПолучитьПараметрыСоединения().Тип = "Файл" ИЛИ Б24_ОбщегоНазначенияПовтИсп.БазаИспользуетсяВМоделиСервиса() тогда
			
			Б24_СинхронизацияВызовСервера.СохранениеСтатусаВыполненияЗагрузкиВРежимеРеальногоВремениВФайлеСервер(Истина);
			
			Б24_СинхронизацияКлиентСервер.ЗапускДлительногоСоедиененияДляЗагрузкиСПорталаОбщий(НастройкаСинхронизации);
			
		Иначе
			
			НаименованиеФоновогоЗадания = Б24_СинхронизацияВызовСервера.ПолучитьНазваниеФоновогоЗаданияЗагрузкиВРежимеРеальногоВремени();
			
			Если Б24_СинхронизацияВызовСервера.СейчасВыполняетсяЗадание(НаименованиеФоновогоЗадания) тогда
				Возврат;			
			Конецесли;
			
			Б24_СинхронизацияВызовСервера.СохранениеСтатусаВыполненияЗагрузкиВРежимеРеальногоВремениВФайлеСервер(Истина);
			
			ЗапуститьФоновоеЗаданиеЗагрузкиРеальногоВремени(НаименованиеФоновогоЗадания, НастройкаСинхронизации);

		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры
