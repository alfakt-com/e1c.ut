
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	//Вставить содержимое обработчика.
	//ПараметрыФормы = Новый Структура("", );
	//ОткрытьФорму("ОбщаяФорма.", ПараметрыФормы, ПараметрыВыполненияКоманды.Источник, ПараметрыВыполненияКоманды.Уникальность, ПараметрыВыполненияКоманды.Окно, ПараметрыВыполненияКоманды.НавигационнаяСсылка);
	ЗначениеОтбора = Новый Структура("Владелец", ПолучитьДопСвойство());
	ПараметрыВыбора = Новый Структура("Отбор,РежимВыбора", ЗначениеОтбора,Истина);
	ОписаниеОповещения = Новый ОписаниеОповещения("УстановитьПараметрДопСведенияКлиент", ЭтотОбъект, ПараметрКоманды );
	ОткрытьФорму("Справочник.ЗначенияСвойствОбъектов.ФормаВыбора", ПараметрыВыбора,ЭтотОбъект,,,,ОписаниеОповещения);	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьПараметрДопСведенияКлиент(Результат, ДокСсылка) Экспорт
	УстановитьПараметрДопСведения(Результат, ДокСсылка);
КонецПроцедуры

&НаСервере
Процедура УстановитьПараметрДопСведения(Результат, ДокСсылка)
	УстановитьПривилегированныйРежим(Истина);
	Если (ТипЗнч(ДокСсылка) = Тип("ДокументСсылка.ЗаказКлиента") или ТипЗнч(ДокСсылка) = Тип("ДокументСсылка.ПеремещениеТоваров")) и ЗначениеЗаполнено(Результат) Тогда
		Если ПроверкаНаСозданиеРеалки(ДокСсылка) Тогда
			Сообщить("По данноу заказу уже есть созданный документ Реализация товаров услуг. Аннулирование отменено!");
			Возврат;	
		КонецЕсли;
		ДопРеквизитАннулировать = ПолучитьДопСвойство();
		ДопРеквизитАннулироватьДата = ПолучитьДопСвойство("Дата аннулирования WMS");
		ДопРеквизитАннулироватьПользователь = ПолучитьДопСвойство("Аннулировал пользователь");
		
		МассивСтруктур = Новый Массив;
		МассивСтруктур.Добавить(Новый Структура("Свойство, Значение", ДопРеквизитАннулировать, Результат));
		МассивСтруктур.Добавить(Новый Структура("Свойство, Значение", ДопРеквизитАннулироватьДата, ТекущаяДата()));
		МассивСтруктур.Добавить(Новый Структура("Свойство, Значение", ДопРеквизитАннулироватьПользователь, ПараметрыСеанса.ТекущийПользователь));
		УправлениеСвойствами.ЗаписатьСвойстваУОбъекта(ДокСсылка, МассивСтруктур);
		Сообщить(""+ДокСсылка+" передан на аннулирование в WMS системе");
	КонецЕсли;
КонецПроцедуры

Функция ПолучитьДопСвойство(НаименованиеПараметра = Неопределено)
	Если НаименованиеПараметра = Неопределено Тогда
		текПараметр = "Аннулировать заказ в WMS";
	Иначе
		текПараметр = НаименованиеПараметра;
	КонецЕсли;
	
	Возврат ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию(текПараметр);	
КонецФункции


Функция ПроверкаНаСозданиеРеалки(Заказ)
	Если НЕ ТипЗнч(Заказ) = Тип("ДокументСсылка.ЗаказКлиента") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Рез = Ложь;
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СвязанныеДокументы.Ссылка КАК Ссылка
	               |ИЗ
	               |	КритерийОтбора.СвязанныеДокументы(&Заказ) КАК СвязанныеДокументы
	               |ГДЕ
	               |	СвязанныеДокументы.Ссылка.Проведен";
	Запрос.УстановитьПараметр("Заказ",Заказ);
	
	РезультатЗапроса = Запрос.Выполнить();	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ТипЗнч(ВыборкаДетальныеЗаписи.Ссылка) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
			Рез = Истина;
			Возврат Рез;
		КонецЕсли;	
	КонецЦикла;
	
	Возврат Рез;
	
КонецФункции